{% extends 'base/base.html' %} {% load static %} {% block content %}

<section class="ftco-section ftco-cart">
  <div class="container">
    <div class="row">
      <div class="col-md-12 ftco-animate">
        <div class="cart-list">
          <form action="{% url 'cart:update_cart' %}" method="post">
            {% csrf_token %}
            <table class="table">
              <thead class="thead-primary">
                <tr class="text-center">
                  <th>&nbsp;</th>
                  <th>&nbsp;</th>
                  <th>Product name</th>
                  <th>Price</th>
                  <th>Quantity</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                {% for item in cart %}
                <tr class="text-center">
                  <td class="product-remove">
                    <a href="{% url 'cart:remove_from_cart' item.product.id %}"
                      ><span class="ion-ios-close"></span
                    ></a>
                  </td>
                  <td class="image-prod">
                    <div
                      class="img"
                      style="background-image:url({{ item.product.photo.url }});"
                    ></div>
                  </td>
                  <td class="product-name">
                    <h3>{{ item.product.name }}</h3>
                    <p>{{ item.product.details|truncatewords:10 }}</p>
                  </td>
                  <td class="price">Ksh {{ item.price|floatformat:2 }}</td>
                  <td class="quantity">
                    <div class="input-group mb-3">
                      <input
                        type="number"
                        name="quantity_{{ item.product.id }}"
                        class="quantity form-control input-number"
                        value="{{ item.quantity|default:1 }}"
                        min="1"
                        max="{{ item.product.stock }}"
                      />
                    </div>
                  </td>
                  <td class="total">
                    Ksh {{ item.total_price|floatformat:2 }}
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="6" class="text-center py-5">
                    <h4>Your cart is empty.</h4>
                    <p>
                      <a href="{% url 'shop:shop' %}" class="btn btn-primary"
                        >Shop Now</a
                      >
                    </p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="text-right">
              {% if cart %}
              <button type="submit" class="btn btn-info">Update Cart</button>
              {% endif %}
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="row justify-content-end">
      <div class="col-lg-4 mt-5 cart-wrap ftco-animate">
        <div class="cart-total mb-3">
          <h3>Cart Totals</h3>
          <p class="d-flex">
            <span>Subtotal</span>
            <span id="subtotal"
              >Ksh {{ cart.get_total_price|floatformat:2 }}</span
            >
          </p>
          <p class="d-flex">
            <span>Delivery</span>
            <span>Ksh 0.00</span>
          </p>
          <p class="d-flex">
            <span>Discount</span>
            <span>Ksh 0.00</span>
          </p>
          <hr />
          <p class="d-flex total-price">
            <span>Total</span>
            <span id="grand-total"
              >Ksh {{ cart.get_total_price|floatformat:2 }}</span
            >
          </p>
        </div>
        <p>
          <a href="{% url 'cart:checkout' %}" class="btn btn-primary py-3 px-4"
            >Proceed to Checkout</a
          >
        </p>
      </div>
    </div>
  </div>
</section>

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const quantityInputs = document.querySelectorAll(
      '.quantity input[type="number"]'
    );

    function updateTotals() {
      let subtotal = 0;
      document.querySelectorAll("tbody tr.text-center").forEach((row) => {
        const priceText = row
          .querySelector(".price")
          .textContent.replace("Ksh", "")
          .trim();
        const price = parseFloat(priceText);
        const quantity = parseInt(
          row.querySelector(".quantity input").value,
          10
        );

        if (!isNaN(price) && !isNaN(quantity)) {
          const total = price * quantity;
          row.querySelector(".total").textContent = "Ksh " + total.toFixed(2);
          subtotal += total;
        }
      });

      document.getElementById("subtotal").textContent =
        "Ksh " + subtotal.toFixed(2);
      document.getElementById("grand-total").textContent =
        "Ksh " + subtotal.toFixed(2);
    }

    quantityInputs.forEach((input) =>
      input.addEventListener("change", updateTotals)
    );
  });
</script>
{% endblock %} {% endblock %}
